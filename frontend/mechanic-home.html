<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mechanic Dashboard | RoadRescue360</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="logo">
                <h1><i class="fas fa-wrench"></i> <span class="logo-text">Mechanic<span class="logo-highlight">Desk</span></span></h1>
            </div>
            <div class="nav-links">
                <a href="mechanic-home.html" class="active">Home</a>
                <a href="#assignments">Assignments</a>
                <a href="#profile">Profile</a>
                <a href="#" id="logout">Logout</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <section class="page-header" style="margin-bottom:30px;">
                <h1>Mechanic Desk</h1>
                <p>Track customer requests, view assigned jobs, and keep your profile up to date. Everything you need to deliver fast roadside assistance.</p>
                <div class="services-grid" style="margin-top:25px;">
                    <div class="service-item" style="min-height:auto; text-align:center;">
                        <h3 style="margin-bottom:8px;">Active Jobs</h3>
                        <div class="stat-number" id="stat-active">0</div>
                    </div>
                    <div class="service-item" style="min-height:auto; text-align:center;">
                        <h3 style="margin-bottom:8px;">Pending</h3>
                        <div class="stat-number" id="stat-pending">0</div>
                    </div>
                    <div class="service-item" style="min-height:auto; text-align:center;">
                        <h3 style="margin-bottom:8px;">Completed</h3>
                        <div class="stat-number" id="stat-completed">0</div>
                    </div>
                </div>
            </section>
            <section class="services-section">
                <h2 class="section-title"><i class="fas fa-clipboard-list section-title-icon"></i> Active Assignments</h2>
                <div id="assignments" class="services-grid"></div>
                <small style="display:block;text-align:center;color:var(--secondary);margin-top:10px;">Assignments reflect live bookings from users and status updates.</small>
            </section>
            <section class="services-section">
                <h2 class="section-title"><i class="fas fa-users section-title-icon"></i> Customers</h2>
                <div class="service-item" style="padding:20px;">
                    <form id="c-form" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <input id="c-name" placeholder="Name" required>
                        <input id="c-phone" placeholder="Phone" required>
                        <input id="c-note" placeholder="Note">
                        <button class="btn btn-primary" type="submit">Add Customer</button>
                    </form>
                    <div id="c-list" class="details-grid" style="margin-top:15px;"></div>
                </div>
            </section>
            <section class="services-section">
                <h2 class="section-title"><i class="fas fa-tools section-title-icon"></i> Services</h2>
                <div class="service-item" style="padding:20px;">
                    <form id="s-form" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <input id="s-name" placeholder="Service name" required>
                        <input id="s-price" type="number" min="0" placeholder="Price" required>
                        <button class="btn btn-primary" type="submit">Add Service</button>
                    </form>
                    <div id="s-list" class="details-grid" style="margin-top:15px;"></div>
                </div>
            </section>
            <section class="services-section">
                <h2 class="section-title"><i class="fas fa-briefcase section-title-icon"></i> Jobs</h2>
                <div class="service-item" style="padding:20px;">
                    <form id="j-form" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <select id="j-customer" required></select>
                        <select id="j-service" required></select>
                        <input id="j-notes" placeholder="Notes">
                        <button class="btn btn-primary" type="submit">Create Job</button>
                    </form>
                    <div id="j-list" class="details-grid" style="margin-top:15px;"></div>
                </div>
            </section>
            <section id="profile" class="services-section">
                <h2 class="section-title"><i class="fas fa-id-badge section-title-icon"></i> My Profile</h2>
                <div class="service-item" style="padding: 20px;">
                    <div style="display:flex; gap:20px; align-items:flex-start;">
                        <div>
                            <img id="avatar" src="https://via.placeholder.com/120x120?text=Avatar" alt="Avatar" style="width:120px;height:120px;border-radius:50%;object-fit:cover;border:3px solid var(--primary-light);">
                            <form id="avatar-form" style="margin-top:10px;">
                                <input type="file" id="avatar-file" accept="image/*">
                                <button class="btn btn-primary" type="submit" style="margin-top:6px;">Upload</button>
                            </form>
                        </div>
                        <div style="flex:1;">
                            <div id="me-profile">Loading...</div>
                            <form id="profile-form" style="margin-top:15px;">
                                <div class="details-grid">
                                    <div class="detail-card"><div class="detail-content"><div class="detail-label">Name</div><input id="p-name"></div></div>
                                    <div class="detail-card"><div class="detail-content"><div class="detail-label">Phone</div><input id="p-phone"></div></div>
                                    <div class="detail-card"><div class="detail-content"><div class="detail-label">Vehicle</div><input id="p-vehicle"></div></div>
                                    <div class="detail-card"><div class="detail-content"><div class="detail-label">License Plate</div><input id="p-plate"></div></div>
                                    <div class="detail-card full-width"><div class="detail-content"><div class="detail-label">Specialties (comma-separated)</div><input id="p-specialties"></div></div>
                                </div>
                                <button class="btn btn-primary" type="submit" style="margin-top:10px;">Save Changes</button>
                            </form>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
    <script src="config.js"></script>
    <script>
        function getToken() { try { return JSON.parse(localStorage.getItem('rr_tech_token')); } catch (_) { return null; } }
        function authHeader() { const t = getToken(); return t ? { 'Authorization': 'Bearer ' + t } : {}; }
        function ensureAuth() { if (!getToken()) { window.location.href = 'login.html'; } }
        ensureAuth();

        document.getElementById('logout').addEventListener('click', (e) => {
            e.preventDefault(); localStorage.removeItem('rr_tech_token'); window.location.href = 'login.html';
        });

        async function loadAssignments() {
            const container = document.getElementById('assignments');
            container.innerHTML = '';
            try {
                const res = await fetch('/api/services/assigned/me', { headers: { ...authHeader() } });
                const services = await res.json();
                const my = services.slice(0,8);
                // stats
                const active = services.filter(s=> s.status==='assigned' || s.status==='in_progress').length;
                const pending = services.filter(s=> s.status==='pending').length;
                const completed = services.filter(s=> s.status==='completed').length;
                document.getElementById('stat-active').textContent = active;
                document.getElementById('stat-pending').textContent = pending;
                document.getElementById('stat-completed').textContent = completed;
                if (!my.length) {
                    container.innerHTML = '<div class="service-item">No assignments yet. New user bookings will appear here automatically.</div>';
                } else {
                    my.forEach(s => {
                        const el = document.createElement('div');
                        el.className = 'service-item';
                        const contact = `${s.contactName || 'Customer'} â€¢ ${s.contactPhone || ''}`;
                        const addr = s.address || '';
                        const v = s.vehicleDetails ? `${s.vehicleDetails.year || ''} ${s.vehicleDetails.make || ''} ${s.vehicleDetails.model || ''}`.trim() : '';
                        const assigned = s.assignedTechnician ? 'Assigned' : 'Unassigned';
                        const coords = (s.location && s.location.coordinates && s.location.coordinates.length===2) ? {lng:s.location.coordinates[0], lat:s.location.coordinates[1]} : null;
                        const mapImg = coords ? `https://maps.googleapis.com/maps/api/staticmap?center=${coords.lat},${coords.lng}&zoom=14&size=400x180&markers=color:red%7C${coords.lat},${coords.lng}` : '';
                        const timeline = `
                            <div class="timeline" style="margin-top:10px;">
                                <div class="timeline-item ${s.status!=='pending'?'completed':''}"><div class="timeline-marker"><i class="fas fa-check"></i></div><div class="timeline-content"><div class="timeline-title">Request Received</div></div></div>
                                <div class="timeline-item ${s.status==='assigned' || s.status==='in_progress' || s.status==='completed'?'active':''}"><div class="timeline-marker"><i class="fas fa-user-cog"></i></div><div class="timeline-content"><div class="timeline-title">Technician Assigned</div></div></div>
                                <div class="timeline-item ${s.status==='in_progress' || s.status==='completed'?'active':''}"><div class="timeline-marker"><i class="fas fa-route"></i></div><div class="timeline-content"><div class="timeline-title">En Route</div></div></div>
                                <div class="timeline-item ${s.status==='completed'?'completed':''}"><div class="timeline-marker"><i class="fas fa-flag-checkered"></i></div><div class="timeline-content"><div class="timeline-title">Completed</div></div></div>
                            </div>`;
                        el.innerHTML = `
                            <div class="service-icon"><i class="fas fa-clipboard-check"></i></div>
                            <div class="service-category"><span><i class="fas fa-tag"></i> ${s.type}</span></div>
                            <h3>${contact}</h3>
                            <p><i class="fas fa-map-marker-alt"></i> ${addr}</p>
                            <p><i class="fas fa-car"></i> ${v || 'N/A'}</p>
                            ${mapImg ? `<img src="${mapImg}" alt="map" style="width:100%;border-radius:10px;margin:6px 0;">` : ''}
                            ${timeline}
                            <div class="service-buttons">
                                <a class="btn-learn" href="track-service.html">Track</a>
                                <span class="btn-book" style="text-align:center;">${assigned}</span>
                            </div>`;
                        container.appendChild(el);
                    });
                }
            } catch (e) {
                container.innerHTML = '<div class="service-item">Failed to load assignments.</div>';
            }
        }

        async function loadProfile() {
            const box = document.getElementById('me-profile');
            box.textContent = 'Loading...';
            try {
                const res = await fetch('/api/auth/technician/me', { headers: { ...authHeader() } });
                const tech = await res.json();
                if (!res.ok) throw new Error(tech.error || 'Failed to load');
                document.getElementById('avatar').src = tech.avatarUrl || document.getElementById('avatar').src;
                box.innerHTML = `
                    <p><strong>Name:</strong> ${tech.name}</p>
                    <p><strong>Email:</strong> ${tech.email}</p>
                    <p><strong>Phone:</strong> ${tech.phone || ''}</p>
                    <p><strong>Vehicle:</strong> ${tech.vehicle || ''}</p>
                    <p><strong>License Plate:</strong> ${tech.licensePlate || ''}</p>
                    <p><strong>Specialties:</strong> ${(tech.specialties||[]).join(', ')}</p>
                `;
                document.getElementById('p-name').value = tech.name || '';
                document.getElementById('p-phone').value = tech.phone || '';
                document.getElementById('p-vehicle').value = tech.vehicle || '';
                document.getElementById('p-plate').value = tech.licensePlate || '';
                document.getElementById('p-specialties').value = (tech.specialties||[]).join(', ');
            } catch (e) {
                box.textContent = 'Failed to load profile.';
            }
        }

        loadAssignments();
        loadProfile();

        // Save profile
        document.getElementById('profile-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                name: document.getElementById('p-name').value.trim(),
                phone: document.getElementById('p-phone').value.trim(),
                vehicle: document.getElementById('p-vehicle').value.trim(),
                licensePlate: document.getElementById('p-plate').value.trim(),
                specialties: document.getElementById('p-specialties').value.split(',').map(s=>s.trim()).filter(Boolean)
            };
            const res = await fetch('/api/auth/technician/me', { method: 'PUT', headers: { 'Content-Type': 'application/json', ...authHeader() }, body: JSON.stringify(payload) });
            const data = await res.json();
            if (!res.ok) return alert(data.error || 'Update failed');
            alert('Profile updated');
            loadProfile();
        });

        // Upload avatar
        document.getElementById('avatar-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('avatar-file').files[0];
            if (!file) return alert('Choose an image');
            const fd = new FormData();
            fd.append('avatar', file);
            const res = await fetch('/api/auth/technician/avatar', { method: 'POST', headers: { ...authHeader() }, body: fd });
            const data = await res.json();
            if (!res.ok) return alert(data.error || 'Upload failed');
            document.getElementById('avatar').src = data.avatarUrl;
        });

        // MD helpers
        async function mdGet(path){ const r= await fetch('/api/md'+path,{ headers:{ ...authHeader(), 'Content-Type':'application/json'}}); return r.json(); }
        async function mdPost(path, body){ const r= await fetch('/api/md'+path,{ method:'POST', headers:{ ...authHeader(), 'Content-Type':'application/json'}, body: JSON.stringify(body)}); return r.json(); }
        async function mdPut(path, body){ const r= await fetch('/api/md'+path,{ method:'PUT', headers:{ ...authHeader(), 'Content-Type':'application/json'}, body: JSON.stringify(body)}); return r.json(); }

        // Customers UI
        async function refreshCustomers(){
            const list = await mdGet('/customers');
            const box = document.getElementById('c-list');
            box.innerHTML = '';
            list.forEach(c=>{
                const el = document.createElement('div');
                el.className='detail-card';
                el.innerHTML = `<div class="detail-content"><div class="detail-label">${c.name}</div><div class="detail-value">${c.phone}${c.note? ' â€¢ '+c.note:''}</div></div>`;
                box.appendChild(el);
            });
            // populate dropdown
            const sel = document.getElementById('j-customer');
            sel.innerHTML = '<option value="" disabled selected>Select customer</option>' + list.map(c=>`<option value="${c._id}">${c.name} (${c.phone})</option>`).join('');
        }
        document.getElementById('c-form').addEventListener('submit', async (e)=>{
            e.preventDefault();
            await mdPost('/customers',{ name: document.getElementById('c-name').value.trim(), phone: document.getElementById('c-phone').value.trim(), note: document.getElementById('c-note').value.trim() });
            (document.getElementById('c-form')).reset();
            refreshCustomers();
        });

        // Services UI
        async function refreshServices(){
            const list = await mdGet('/services');
            const box = document.getElementById('s-list');
            box.innerHTML='';
            list.forEach(s=>{
                const el = document.createElement('div');
                el.className='detail-card';
                el.innerHTML = `<div class="detail-content"><div class="detail-label">${s.name}</div><div class="detail-value">â‚¹${s.price}</div></div>`;
                box.appendChild(el);
            });
            const sel = document.getElementById('j-service');
            sel.innerHTML = '<option value="" disabled selected>Select service</option>' + list.map(s=>`<option value="${s._id}">${s.name} (â‚¹${s.price})</option>`).join('');
        }
        document.getElementById('s-form').addEventListener('submit', async (e)=>{
            e.preventDefault();
            await mdPost('/services',{ name: document.getElementById('s-name').value.trim(), price: Number(document.getElementById('s-price').value) });
            (document.getElementById('s-form')).reset();
            refreshServices();
        });

        // Jobs UI
        async function refreshJobs(){
            const list = await mdGet('/jobs');
            const box = document.getElementById('j-list');
            box.innerHTML='';
            list.forEach(j=>{
                const el = document.createElement('div');
                el.className='detail-card full-width';
                el.innerHTML = `<div class="detail-content"><div class="detail-label">${j.customer?.name || ''} â†’ ${j.service?.name || ''}</div><div class="detail-value">Status: <strong>${j.status}</strong></div></div><div><select data-id="${j._id}"><option ${j.status==='pending'?'selected':''}>pending</option><option ${j.status==='in_progress'?'selected':''}>in_progress</option><option ${j.status==='completed'?'selected':''}>completed</option></select></div>`;
                box.appendChild(el);
                const sel = el.querySelector('select');
                sel.addEventListener('change', async ()=>{ await mdPut('/jobs/'+j._id, { status: sel.value }); refreshJobs(); });
            });
        }
        document.getElementById('j-form').addEventListener('submit', async (e)=>{
            e.preventDefault();
            await mdPost('/jobs',{ customerId: document.getElementById('j-customer').value, serviceId: document.getElementById('j-service').value, notes: document.getElementById('j-notes').value.trim() });
            (document.getElementById('j-form')).reset();
            refreshJobs();
        });

        // Initial loads
        refreshCustomers();
        refreshServices();
        refreshJobs();
    </script>
</body>
</html>


