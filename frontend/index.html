<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RoadRescue360 | Fast & Reliable Roadside Assistance</title>
    <meta
      name="description"
      content="RoadRescue360 - Professional roadside assistance services available 24/7. Get help with flat tires, battery jump starts, lockouts, towing, and more."
    />
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Racing+Sans+One&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Oswald:wght@500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="icon" type="image/png" href="images/favicon.png" />
    <script src="config.js"></script>
    <script src="location-service.js"></script>
    <script src="technician-service.js"></script>
    <script src="pricing-service.js"></script>
    <script src="user-profile-service.js"></script>
    <script src="payment-service.js"></script>
    <script>
        // Test function to check if pre-filling is working
        function testPrefill() {
            console.log('Testing pre-fill...');
            console.log('User logged in:', window.userProfileService?.isLoggedIn());
            console.log('Profile data:', window.userProfileService?.profileData);
            
            // Create a test form
            const testForm = document.createElement('form');
            testForm.innerHTML = `
                <input type="text" id="test-name" placeholder="Name">
                <input type="tel" id="test-phone" placeholder="Phone">
                <input type="email" id="test-email" placeholder="Email">
                <input type="text" id="test-location" placeholder="Location">
                <textarea id="test-vehicle" placeholder="Vehicle"></textarea>
            `;
            
            document.body.appendChild(testForm);
            
            // Pre-fill it
            if (window.prefillFormWithUserData) {
                window.prefillFormWithUserData(testForm);
                console.log('Pre-fill test completed');
            }
        }
        
        // Make test function available globally
        window.testPrefill = testPrefill;
    </script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB41DRUbKWJHPxaFjMAwdrzWzbVKartNGg"
      defer
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="script.js"></script>
    <script src="emergency.js"></script>
    <script src="tracking.js"></script>
    <script src="combine-booking.js"></script>
    <script src="message-fix.js" defer></script>
    <script src="schedule.js" defer></script>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="container">
            <div class="logo">
          <h1>
            <i class="fas fa-car-crash"></i>
            <span class="logo-text"
              >ROAD<span class="logo-highlight">RESCUE</span
              ><span class="logo-number">360</span></span
            >
          </h1>
            </div>
            <div class="nav-links">
                <a href="index.html" class="active">Home</a>
                <a href="#services">Services</a>
                <a href="schedule-service.html">Schedule</a>
                <a href="track-service.html">Track</a>
                <a href="ratings.html">Ratings</a>
                <a href="faq.html">FAQ</a>
                <a href="about.html">About Us</a>
                <a href="contact.html">Contact</a>
                <a href="user-profile.html" id="nav-profile" style="display: none">
                    <i class="fas fa-user"></i> Profile
                </a>
                <a href="login.html" id="nav-login">Login</a>
          <a href="mechanic-home.html" id="nav-mechanic" style="display: none"
            >Mechanic</a
          >
          <a href="#" id="nav-logout" style="display: none">Logout</a>
            </div>
            <div class="theme-toggle" id="theme-toggle">
                <i class="fas fa-sun"></i>
                <div class="toggle-track">
                    <div class="toggle-thumb"></div>
                </div>
                <i class="fas fa-moon"></i>
            </div>
            <div class="mobile-menu" id="mobile-menu">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero" id="home">
        <div class="container">
            <div class="hero-content">
                <div class="badge-wrapper">
            <span class="hero-badge"
              ><i class="fas fa-star"></i> Trusted Service</span
            >
                </div>
                <h1>RoadRescue360: 24/7 Roadside Assistance You Can Trust</h1>
          <p>
            We're there when you need us most. Fast response times, affordable
            rates, and professional service for all your roadside emergencies.
          </p>
                <div class="hero-buttons">
            <button class="cta-button sos-button" id="sos-btn">
              <i class="fas fa-exclamation-triangle"></i> SOS EMERGENCY
                    </button>
                </div>
                <div class="hero-stats">
                    <div class="stat-item">
                        <div class="stat-number">5000+</div>
                        <div class="stat-label">Customers Served</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">15 min</div>
                        <div class="stat-label">Avg. Response Time</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number">98%</div>
                        <div class="stat-label">Satisfaction Rate</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Services Section -->
    <section class="services-section" id="services">
        <div class="container">
            <h2 class="section-title">
                <i class="fas fa-tools section-title-icon"></i>
                Our Services
            </h2>
            <div class="services-grid">
                <div class="service-item">
                    <div class="service-icon">
                        <i class="fas fa-car-battery"></i>
                    </div>
            <div class="service-category">
              <span><i class="fas fa-bolt"></i> Urgent Help</span>
            </div>
                    <h3>Battery Jump Start</h3>
            <p>
              Get back on the road quickly with our professional jump start
              service. Our technicians will arrive promptly with the right
              equipment to get your vehicle running again.
            </p>
                    <div class="service-buttons">
              <a href="#" class="btn-learn" data-service="battery"
                >Learn More</a
              >
                        <a href="#" class="btn-book" data-service="battery">Book Now</a>
                    </div>
                </div>
                <div class="service-item">
                    <div class="service-icon">
                        <i class="fas fa-gas-pump"></i>
                    </div>
            <div class="service-category">
              <span><i class="fas fa-tachometer-alt"></i> Emergency</span>
            </div>
                    <h3>Fuel Delivery</h3>
            <p>
              Run out of fuel? Don't worry, we'll deliver the fuel you need
              directly to your location, getting you back on the road without
              the hassle of finding a gas station.
            </p>
                    <div class="service-buttons">
                        <a href="#" class="btn-learn" data-service="fuel">Learn More</a>
                        <a href="#" class="btn-book" data-service="fuel">Book Now</a>
                    </div>
                </div>
                <div class="service-item">
                    <div class="service-icon">
                        <i class="fas fa-key"></i>
                    </div>
            <div class="service-category">
              <span><i class="fas fa-unlock"></i> Quick Service</span>
            </div>
                    <h3>Lockout Service</h3>
            <p>
              Locked your keys in your car? Our specialists use professional
              tools and techniques to safely unlock your vehicle without causing
              any damage.
            </p>
                    <div class="service-buttons">
              <a href="#" class="btn-learn" data-service="lockout"
                >Learn More</a
              >
                        <a href="#" class="btn-book" data-service="lockout">Book Now</a>
                    </div>
                </div>
                <div class="service-item">
                    <div class="service-icon">
                        <i class="fas fa-truck-pickup"></i>
                    </div>
            <div class="service-category">
              <span><i class="fas fa-truck"></i> Transport</span>
            </div>
                    <h3>Towing Service</h3>
            <p>
              When your vehicle can't be fixed on the spot, our towing service
              will safely transport your vehicle to your preferred repair shop
              or destination.
            </p>
                    <div class="service-buttons">
                        <a href="#" class="btn-learn" data-service="towing">Learn More</a>
                        <a href="#" class="btn-book" data-service="towing">Book Now</a>
                    </div>
                </div>
                <div class="service-item">
                    <div class="service-icon">
                        <i class="fas fa-tools"></i>
                    </div>
            <div class="service-category">
              <span><i class="fas fa-road"></i> Roadside</span>
            </div>
                    <h3>Flat Tire Change</h3>
            <p>
              Got a flat? Our technicians will quickly replace your flat tire
              with your spare, ensuring you're back on the road safely and
              without delay.
            </p>
                    <div class="service-buttons">
                        <a href="#" class="btn-learn" data-service="tire">Learn More</a>
                        <a href="#" class="btn-book" data-service="tire">Book Now</a>
                    </div>
                </div>
                <div class="service-item">
                    <div class="service-icon">
                        <i class="fas fa-wrench"></i>
                    </div>
            <div class="service-category">
              <span><i class="fas fa-cogs"></i> Technical</span>
            </div>
                    <h3>Mobile Mechanic</h3>
            <p>
              For more complex issues, our mobile mechanics bring the auto shop
              to you. We can diagnose and fix many common problems right at your
              location.
            </p>
                    <div class="service-buttons">
              <a href="#" class="btn-learn" data-service="mechanic"
                >Learn More</a
              >
                        <a href="#" class="btn-book" data-service="mechanic">Book Now</a>
                    </div>
                </div>
          <div class="service-item">
            <div class="service-icon">
              <i class="fas fa-charging-station"></i>
            </div>
            <div class="service-category">
              <span><i class="fas fa-bolt"></i> EV Services</span>
            </div>
            <h3>EV Mobile Charging</h3>
            <p>
              Running low on battery? Our mobile EV charging service brings
              power to your electric vehicle wherever you are. Fast and reliable
              charging to get you back on the road.
            </p>
            <div class="service-buttons">
              <a href="#" class="btn-learn" data-service="ev_charging"
                >Learn More</a
              >
              <a href="#" class="btn-book" data-service="ev_charging"
                >Book Now</a
              >
            </div>
          </div>
          <div class="service-item">
            <div class="service-icon">
              <i class="fas fa-battery-full"></i>
            </div>
            <div class="service-category">
              <span><i class="fas fa-car-battery"></i> EV Services</span>
            </div>
            <h3>EV Battery Swap</h3>
            <p>
              Quick battery replacement service for compatible electric
              vehicles. We bring fully charged batteries and swap them with your
              depleted ones in minutes.
            </p>
            <div class="service-buttons">
              <a href="#" class="btn-learn" data-service="ev_battery_swap"
                >Learn More</a
              >
              <a href="#" class="btn-book" data-service="ev_battery_swap"
                >Book Now</a
              >
            </div>
          </div>
          <div class="service-item">
            <div class="service-icon">
              <i class="fas fa-search"></i>
            </div>
            <div class="service-category">
              <span><i class="fas fa-tools"></i> EV Services</span>
            </div>
            <h3>EV Diagnostics</h3>
            <p>
              Specialized diagnostic services for electric vehicles. Our
              EV-certified technicians can identify and resolve issues with your
              electric vehicle's systems and components.
            </p>
            <div class="service-buttons">
              <a href="#" class="btn-learn" data-service="ev_diagnostics"
                >Learn More</a
              >
              <a href="#" class="btn-book" data-service="ev_diagnostics"
                >Book Now</a
              >
            </div>
          </div>
            </div>
        </div>
    </section>

    <!-- SOS Emergency Modal -->
    <div class="modal" id="sos-modal">
      <div class="modal-content sos-modal-content">
        <button class="close-modal" id="close-sos-modal">&times;</button>
        <div class="sos-header">
          <h2><i class="fas fa-exclamation-triangle"></i> SOS EMERGENCY</h2>
          <p class="sos-subtitle">
            Critical emergency assistance - immediate response
          </p>
                </div>

        <div class="sos-actions">
          <div class="sos-action-card">
            <h3><i class="fas fa-phone"></i> Emergency Numbers</h3>
            <div class="emergency-numbers">
              <button class="emergency-call-btn" onclick="callEmergency('100')">
                <i class="fas fa-phone"></i> Police (100)
              </button>
              <button class="emergency-call-btn" onclick="callEmergency('102')">
                <i class="fas fa-ambulance"></i> Ambulance (102)
              </button>
              <button class="emergency-call-btn" onclick="callEmergency('101')">
                <i class="fas fa-fire"></i> Fire (101)
                    </button>
                </div>
          </div>

          <div class="sos-action-card">
            <h3><i class="fas fa-user-md"></i> Nearby Hospitals</h3>
            <div id="nearby-hospitals">
              <p>Finding nearby hospitals...</p>
            </div>
          </div>

          <div class="sos-action-card">
            <h3><i class="fas fa-tools"></i> Roadside Assistance</h3>
            <div class="service-type-selection">
              <label for="sos-service-type">Service Type:</label>
              <select id="sos-service-type" class="sos-select">
                <option value="emergency">Emergency Assistance</option>
                        <option value="battery">Battery Jump Start</option>
                        <option value="fuel">Fuel Delivery</option>
                <option value="tire">Flat Tire Change</option>
                        <option value="lockout">Lockout Service</option>
                        <option value="towing">Towing Service</option>
                <option value="mechanical">Mobile Mechanic</option>
                <option value="mobile_repair">Mobile Repair</option>
                <option value="accident_recovery">Accident Recovery</option>
                <option value="ev_charging">EV Mobile Charging</option>
                <option value="ev_towing">EV Towing Service</option>
                <option value="ev_battery_swap">EV Battery Swap</option>
                <option value="ev_diagnostics">EV Diagnostics</option>
                    </select>
                </div>
            <button class="sos-assistance-btn" id="request-roadside">
              <i class="fas fa-car-crash"></i> Request Roadside Help
            </button>
                </div>

          <div class="sos-action-card">
            <h3><i class="fas fa-map-marker-alt"></i> Live Location</h3>
            <div id="location-status">
              <p>Getting your location...</p>
                </div>
            <button class="location-btn" id="share-location">
              <i class="fas fa-share-alt"></i> Share Live Location
                </button>
          </div>
        </div>

        <div class="sos-footer">
          <p>
            <i class="fas fa-info-circle"></i> Your location and emergency
            details are being shared with emergency services and nearby
            technicians.
          </p>
        </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal" id="payment-modal">
        <div class="modal-content">
            <button class="close-modal" id="close-payment-modal">&times;</button>
            <h2>Book Roadside Assistance</h2>
        <p>
          Please provide your details to book our
          <span id="service-title">service</span>:
        </p>
            <form id="payment-form">
                <div class="form-group">
                    <label for="payment-name">Your Name</label>
            <input
              type="text"
              id="payment-name"
              name="payment-name"
              placeholder="Enter your full name"
              required
            />
                </div>
                <div class="form-group">
                    <label for="payment-phone">Phone Number</label>
            <input
              type="tel"
              id="payment-phone"
              name="payment-phone"
              placeholder="Enter your phone number"
              required
            />
                </div>
                <div class="form-group">
                    <label for="payment-location">Service Location</label>
            <input
              type="text"
              id="payment-location"
              name="payment-location"
              placeholder="Enter service location"
              required
            />
                    <button type="button" id="payment-use-gps" class="secondary-button">
                        <i class="fas fa-map-marker-alt"></i> Use Current Location
                    </button>
                </div>
                <div class="form-group">
                    <label for="payment-vehicle-info">Vehicle Information</label>
            <input
              type="text"
              id="payment-vehicle-info"
              name="payment-vehicle-info"
              placeholder="Year, Make, Model, Color"
              required
            />
          </div>
          <div class="form-group" id="fuel-type-group" style="display: none">
            <label for="payment-fuel-type">Fuel Type</label>
            <select id="payment-fuel-type" name="payment-fuel-type">
              <option value="">Select fuel type</option>
              <option value="petrol">Petrol</option>
              <option value="diesel">Diesel</option>
              <option value="cng">CNG</option>
            </select>
                </div>
                <div class="form-group">
                    <label for="payment-time">Preferred Service Time</label>
                    <select id="payment-time" name="payment-time" required>
                        <option value="" disabled selected>Select preferred time</option>
                        <option value="asap">As Soon As Possible</option>
                        <option value="today">Later Today</option>
                        <option value="tomorrow">Tomorrow</option>
                        <option value="schedule">Schedule for Later Date</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payment-method">Payment Method</label>
                    <select id="payment-method" name="payment-method" required>
                        <option value="" disabled selected>Select payment method</option>
                        <option value="credit">Credit Card</option>
                        <option value="debit">Debit Card</option>
                        <option value="paypal">PayPal</option>
                        <option value="cash">Cash on Delivery</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payment-notes">Special Instructions</label>
            <textarea
              id="payment-notes"
              name="payment-notes"
              placeholder="Any additional information we should know"
              rows="2"
            ></textarea>
                </div>
                <button type="submit" class="submit-button">
                    <i class="fas fa-check-circle"></i> Confirm Booking
                </button>
            </form>
        </div>
    </div>

    <!-- Service Details Modal -->
    <div class="modal service-details-modal" id="service-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="service-detail-title">Service Details</h2>
          <button class="close-modal" id="close-service-details-modal">
            &times;
          </button>
            </div>
            <div class="modal-body">
                <div class="service-icon large" id="service-detail-icon">
                    <i class="fas fa-car-battery"></i>
                </div>
                <div class="service-description" id="service-detail-description">
                    <p>Loading service details...</p>
                </div>
                <div class="service-features">
                    <h3>Key Features</h3>
                    <ul id="service-detail-features">
                        <li>Loading features...</li>
                    </ul>
                </div>
                <div class="service-pricing" id="service-detail-pricing">
                    <h3>Pricing</h3>
                    <p id="service-detail-price">Loading pricing information...</p>
                </div>
            </div>
            <div class="modal-footer">
          <button class="secondary-button" id="service-details-close">
            Close
          </button>
            </div>
        </div>
    </div>

    <!-- Success Message -->
    <div class="success-message" id="success-message" style="display: none">
        <i class="fas fa-check-circle"></i>
        <div class="message-content">
            <p>Success!</p>
        <p id="success-message-text">
          Your request has been submitted successfully.
        </p>
        </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
            // Auth-aware nav toggles
            try {
          const userToken = JSON.parse(localStorage.getItem("rr_user_token"));
          const techToken = JSON.parse(localStorage.getItem("rr_tech_token"));
          const navLogin = document.getElementById("nav-login");
          const navMechanic = document.getElementById("nav-mechanic");
          const navLogout = document.getElementById("nav-logout");
          const navProfile = document.getElementById("nav-profile");
          if (techToken && navMechanic)
            navMechanic.style.display = "inline-block";
          if (userToken && navProfile)
            navProfile.style.display = "inline-block";
          if ((userToken || techToken) && navLogin)
            navLogin.style.display = "none";
          if ((userToken || techToken) && navLogout)
            navLogout.style.display = "inline-block";
                if (navLogout) {
            navLogout.addEventListener("click", function (e) {
                        e.preventDefault();
              localStorage.removeItem("rr_user_token");
              localStorage.removeItem("rr_tech_token");
                        window.location.reload();
                    });
                }
            } catch (_) {}
            // Modal toggle functions
        const sosBtn = document.getElementById("sos-btn");
        const sosModal = document.getElementById("sos-modal");
        const closeSosModal = document.getElementById("close-sos-modal");

        const paymentModal = document.getElementById("payment-modal");
        const closePaymentModal = document.getElementById(
          "close-payment-modal"
        );

        const serviceDetailsModal = document.getElementById(
          "service-details-modal"
        );
        const closeServiceDetailsModal = document.getElementById(
          "close-service-details-modal"
        );
        const serviceDetailsClose = document.getElementById(
          "service-details-close"
        );

        let currentService = "";

        // SOS modal
        if (sosBtn) {
          sosBtn.addEventListener("click", function () {
            sosModal.style.display = "flex";
            initializeSOS();
          });
        }

        if (closeSosModal) {
          closeSosModal.addEventListener("click", function () {
            sosModal.style.display = "none";
                });
            }
            
            // Payment modal close
            if (closePaymentModal) {
          closePaymentModal.addEventListener("click", function () {
            paymentModal.style.display = "none";
                });
            }
            
            // Service details modal
            if (closeServiceDetailsModal) {
          closeServiceDetailsModal.addEventListener("click", function () {
            serviceDetailsModal.style.display = "none";
                });
            }
            
            if (serviceDetailsClose) {
          serviceDetailsClose.addEventListener("click", function () {
            serviceDetailsModal.style.display = "none";
                });
            }
            
            // Setup Learn More buttons
        const learnMoreButtons = document.querySelectorAll(".btn-learn");
        learnMoreButtons.forEach((button) => {
          button.addEventListener("click", function (e) {
                    e.preventDefault();
            const service = this.getAttribute("data-service");
                    currentService = service;
                    showServiceDetails(service);
                });
            });
            
            // Setup Book Now buttons
        const bookNowButtons = document.querySelectorAll(".btn-book");
        bookNowButtons.forEach((button) => {
          button.addEventListener("click", function (e) {
                    e.preventDefault();
            const service = this.getAttribute("data-service");
                    currentService = service;
                    showPaymentModal(service);
                });
            });
            
            // Function to show service details
            function showServiceDetails(service) {
          const title = document.getElementById("service-detail-title");
          const icon = document.getElementById("service-detail-icon");
          const description = document.getElementById(
            "service-detail-description"
          );
          const features = document.getElementById("service-detail-features");
          const price = document.getElementById("service-detail-price");
                
                // Set details based on service type
                title.textContent = getServiceTitle(service);
                icon.innerHTML = getServiceIcon(service);
                description.innerHTML = getServiceDescription(service);
                features.innerHTML = getServiceFeatures(service);
                price.innerHTML = getServicePricing(service);
                
                // Show the modal
          serviceDetailsModal.style.display = "flex";
            }
            
            // Function to show payment modal
            function showPaymentModal(service) {
          const serviceTitle = document.getElementById("service-title");
                if (serviceTitle) {
                    serviceTitle.textContent = getServiceTitle(service);
                }

          // Show/hide fuel type field based on service type
          const fuelTypeGroup = document.getElementById("fuel-type-group");
          if (fuelTypeGroup) {
            if (service === "fuel") {
              fuelTypeGroup.style.display = "block";
              document.getElementById("payment-fuel-type").required = true;
            } else {
              fuelTypeGroup.style.display = "none";
              document.getElementById("payment-fuel-type").required = false;
            }
          }

          paymentModal.style.display = "flex";
            }
            
            // Helper functions to get service information
            function getServiceTitle(service) {
                const titles = {
            emergency: "Emergency Assistance",
            battery: "Battery Jump Start",
            fuel: "Fuel Delivery",
            lockout: "Lockout Service",
            towing: "Towing Service",
            tire: "Flat Tire Change",
            mechanic: "Mobile Mechanic",
            mechanical: "Mobile Mechanic",
            mobile_repair: "Mobile Repair",
            accident_recovery: "Accident Recovery",
            ev_charging: "EV Mobile Charging",
            ev_towing: "EV Towing Service",
            ev_battery_swap: "EV Battery Swap",
            ev_diagnostics: "EV Diagnostics",
          };
          return titles[service] || "Service";
            }
            
            function getServiceIcon(service) {
                const icons = {
            emergency: '<i class="fas fa-exclamation-triangle"></i>',
            battery: '<i class="fas fa-car-battery"></i>',
            fuel: '<i class="fas fa-gas-pump"></i>',
            lockout: '<i class="fas fa-key"></i>',
            towing: '<i class="fas fa-truck-pickup"></i>',
            tire: '<i class="fas fa-tools"></i>',
            mechanic: '<i class="fas fa-wrench"></i>',
            mechanical: '<i class="fas fa-wrench"></i>',
            mobile_repair: '<i class="fas fa-tools"></i>',
            accident_recovery: '<i class="fas fa-car-crash"></i>',
            ev_charging: '<i class="fas fa-charging-station"></i>',
            ev_towing: '<i class="fas fa-truck-pickup"></i>',
            ev_battery_swap: '<i class="fas fa-battery-full"></i>',
            ev_diagnostics: '<i class="fas fa-search"></i>',
                };
                return icons[service] || '<i class="fas fa-car"></i>';
            }
            
            function getServiceDescription(service) {
                const descriptions = {
            emergency:
              "<p>Emergency roadside assistance for critical situations requiring immediate response. Our emergency team is available 24/7 to handle urgent roadside situations with priority dispatch.</p><p>This service is designed for life-threatening situations, accidents, or when you're in immediate danger. Our emergency response team will coordinate with local authorities and medical services as needed.</p>",
            battery:
              "<p>Our professional Battery Jump Start service gets you back on the road quickly when your battery fails. We come equipped with commercial-grade jumper cables and portable power packs that can start almost any vehicle without needing another car.</p><p>Our technicians are trained to safely jump-start your vehicle while protecting your car's sensitive electronics. We'll also perform a basic check of your charging system to identify potential issues.</p>",
            fuel: "<p>Running out of fuel can happen to anyone. Our Fuel Delivery service brings the gas station to you, saving you the hassle and potential danger of leaving your vehicle.</p><p>We deliver premium, regular, or diesel fuel directly to your location. Our service vehicles carry secure fuel containers, allowing us to provide enough fuel to get you to the nearest gas station safely.</p>",
            lockout:
              "<p>Being locked out of your vehicle is frustrating and sometimes even dangerous depending on your location and the weather. Our professional Lockout Service uses specialized tools to safely and quickly regain access to your vehicle.</p><p>Our technicians are trained in the latest entry techniques and use tools designed to prevent damage to your vehicle's locking mechanisms and electronics.</p>",
            towing:
              "<p>When your vehicle can't be fixed on the spot, our professional Towing Service safely transports your vehicle to your preferred destination. We use modern tow trucks and equipment to ensure your vehicle is moved without causing any damage.</p><p>Whether you need a local tow to a nearby mechanic or a long-distance tow to your home or preferred service center, our fleet can accommodate your needs.</p>",
            tire: "<p>Flat tires often happen at the most inconvenient times. Our Flat Tire Change service brings professional assistance right to your location. Our technicians will quickly and safely change your flat tire with your spare.</p><p>If you don't have a spare or if your spare isn't in usable condition, we can tow your vehicle to the nearest tire shop or offer temporary solutions to get you back on the road.</p>",
            mechanic:
              "<p>For more complex issues, our Mobile Mechanic service brings the auto shop to you. Our skilled mechanics arrive with the tools and parts needed to diagnose and repair many common vehicle problems right at your location.</p><p>We can handle issues from electrical problems to minor mechanical repairs, often eliminating the need for a tow to a repair shop.</p>",
            mechanical:
              "<p>For more complex issues, our Mobile Mechanic service brings the auto shop to you. Our skilled mechanics arrive with the tools and parts needed to diagnose and repair many common vehicle problems right at your location.</p><p>We can handle issues from electrical problems to minor mechanical repairs, often eliminating the need for a tow to a repair shop.</p>",
            mobile_repair:
              "<p>Our Mobile Repair service provides on-site vehicle repairs for common issues that can be fixed without specialized equipment. Our technicians bring the necessary tools and parts to your location.</p><p>This service covers minor repairs, part replacements, and basic maintenance tasks that can be completed roadside, saving you time and the need for a tow.</p>",
            accident_recovery:
              "<p>Accident Recovery service provides specialized assistance for vehicles involved in accidents. Our team coordinates with emergency services and insurance companies to ensure proper handling of your vehicle.</p><p>We provide safe vehicle recovery, documentation assistance, and coordination with repair facilities and insurance adjusters to streamline the recovery process.</p>",
            ev_charging:
              "<p>Our EV Mobile Charging service brings power to your electric vehicle wherever you are. We use high-capacity mobile charging units that can provide enough charge to get you to the nearest charging station or your destination.</p><p>Our EV-certified technicians are equipped with fast-charging capabilities and can handle most electric vehicle models. We also provide charging status updates and recommendations for optimal battery health.</p>",
            ev_towing:
              "<p>Specialized towing service for electric vehicles that require careful handling. Our EV towing trucks are equipped with proper equipment to safely transport electric vehicles without damaging their battery systems or electronics.</p><p>We understand the unique requirements of electric vehicles and ensure your EV is transported safely to your preferred destination or charging station.</p>",
            ev_battery_swap:
              "<p>Quick battery replacement service for compatible electric vehicles. We bring fully charged batteries and perform a safe swap with your depleted battery in minutes, getting you back on the road quickly.</p><p>This service is available for vehicles with swappable battery systems. Our technicians are trained in proper battery handling and safety protocols for electric vehicles.</p>",
            ev_diagnostics:
              "<p>Specialized diagnostic services for electric vehicles. Our EV-certified technicians use advanced diagnostic tools to identify issues with your electric vehicle's battery, motor, charging system, and other EV-specific components.</p><p>We can diagnose battery health, charging issues, motor problems, and software-related concerns. Our comprehensive EV diagnostics help ensure your electric vehicle is running at optimal performance.</p>",
          };
          return (
            descriptions[service] ||
            "<p>Detailed information about this service will be provided soon.</p>"
          );
            }
            
            function getServiceFeatures(service) {
                const features = {
            emergency:
              "<li>Priority emergency response</li><li>24/7 availability</li><li>Coordination with emergency services</li><li>Immediate dispatch</li><li>Medical assistance coordination</li>",
            battery:
              "<li>Professional-grade equipment for safe jump starts</li><li>Basic charging system check</li><li>Battery terminal cleaning if needed</li><li>Advice on battery replacement if necessary</li><li>Available 24/7 in all weather conditions</li>",
            fuel: "<li>Fast delivery of regular, premium, or diesel fuel</li><li>Enough fuel to reach the nearest gas station</li><li>Safe handling and transfer of fuel</li><li>Optional fuel container for future emergencies</li><li>Available 24/7 in all weather conditions</li>",
            lockout:
              "<li>Damage-free entry techniques</li><li>Works with all vehicle makes and models</li><li>Specialized tools for modern electronic locks</li><li>Key extraction if keys are stuck in ignition</li><li>Available 24/7 in all weather conditions</li>",
            towing:
              "<li>Flatbed and wheel-lift towing available</li><li>Short and long-distance towing options</li><li>Careful handling of low-clearance vehicles</li><li>Motorcycle towing capabilities</li><li>Available 24/7 in all weather conditions</li>",
            tire: "<li>Fast and safe tire changes</li><li>Proper torquing of lug nuts</li><li>Inspection of spare tire condition</li><li>Basic inspection of other tires</li><li>Available 24/7 in all weather conditions</li>",
            mechanic:
              "<li>On-site diagnostics using professional tools</li><li>Minor repairs completed on location</li><li>Battery testing and replacement</li><li>Starter and alternator testing</li><li>Scheduled appointments available</li>",
            mechanical:
              "<li>On-site diagnostics using professional tools</li><li>Minor repairs completed on location</li><li>Battery testing and replacement</li><li>Starter and alternator testing</li><li>Scheduled appointments available</li>",
            mobile_repair:
              "<li>On-site repair services</li><li>Common part replacements</li><li>Basic maintenance tasks</li><li>Tool and equipment transport</li><li>Time-saving convenience</li>",
            accident_recovery:
              "<li>Specialized accident recovery</li><li>Insurance coordination</li><li>Documentation assistance</li><li>Safe vehicle transport</li><li>Emergency service coordination</li>",
            ev_charging:
              "<li>High-capacity mobile charging units</li><li>Fast-charging capabilities</li><li>EV-certified technicians</li><li>Battery health monitoring</li><li>Charging status updates</li>",
            ev_towing:
              "<li>Specialized EV towing equipment</li><li>Battery system protection</li><li>Safe transport protocols</li><li>Charging station coordination</li><li>EV-specific handling</li>",
            ev_battery_swap:
              "<li>Quick battery replacement</li><li>Fully charged batteries</li><li>Safe handling protocols</li><li>Compatible vehicle support</li><li>Professional installation</li>",
            ev_diagnostics:
              "<li>Advanced EV diagnostic tools</li><li>Battery health analysis</li><li>Motor system diagnostics</li><li>Charging system testing</li><li>Software diagnostics</li>",
          };
          return features[service] || "<li>Features will be listed soon</li>";
            }
            
            function getServicePricing(service) {
                const pricing = {
            emergency:
              "Emergency response: $149.99<br>Priority dispatch with immediate response. Additional charges may apply for specialized equipment or extended response time.",
            battery:
              "Starting at $69.99 for standard vehicles<br>Additional charges may apply for commercial vehicles or difficult access locations.",
            fuel: "Service fee: $49.99 plus the cost of fuel<br>Premium and diesel fuel available at current market prices.",
            lockout:
              "Starting at $79.99 for standard vehicles<br>Additional charges may apply for high-security locks or complex electronic systems.",
            towing:
              "Starting at $99.99 for local towing (up to 5 miles)<br>$3.50 per additional mile for long-distance towing.",
            tire: "Starting at $59.99 for standard vehicles<br>Additional charges may apply for commercial vehicles or specialty tires.",
            mechanic:
              "Diagnostic fee: $89.99 (applied toward repair cost if service is performed)<br>Repair costs provided after diagnosis.",
            mechanical:
              "Diagnostic fee: $89.99 (applied toward repair cost if service is performed)<br>Repair costs provided after diagnosis.",
            mobile_repair:
              "Starting at $79.99 for basic repairs<br>Parts and labor costs provided after assessment. Service fee waived if repair is completed.",
            accident_recovery:
              "Starting at $199.99 for accident recovery<br>Includes documentation, coordination with insurance, and safe transport. Additional charges for specialized equipment.",
            ev_charging:
              "Starting at $89.99 for EV mobile charging<br>Includes charging service and battery health check. Additional charges for extended charging time or premium charging rates.",
            ev_towing:
              "Starting at $129.99 for EV towing<br>Specialized EV towing with battery protection. Additional charges for long-distance towing or specialized equipment.",
            ev_battery_swap:
              "Starting at $199.99 for EV battery swap<br>Includes battery replacement and system check. Additional charges for premium batteries or complex installations.",
            ev_diagnostics:
              "Starting at $119.99 for EV diagnostics<br>Comprehensive EV system analysis and health report. Additional charges for detailed reports or specialized testing.",
          };
          return (
            pricing[service] || "Please call for current pricing information."
          );
        }

        // Test service type button
        const testServiceTypeBtn = document.getElementById("test-service-type");
        if (testServiceTypeBtn) {
          testServiceTypeBtn.addEventListener("click", function () {
            const serviceTypeSelect = document.getElementById("service-type");
            const formData = new FormData(
              document.getElementById("emergency-form")
            );

            console.log("ðŸ§ª Service Type Test:", {
              selectValue: serviceTypeSelect?.value,
              selectSelectedIndex: serviceTypeSelect?.selectedIndex,
              formDataValue: formData.get("service-type"),
              selectedOption: serviceTypeSelect?.selectedOptions?.[0],
              allOptions: Array.from(serviceTypeSelect?.options || []).map(
                (opt) => ({
                  value: opt.value,
                  text: opt.text,
                  selected: opt.selected,
                })
              ),
            });

            alert(
              `Service Type: "${serviceTypeSelect?.value}"\nSelected Index: ${serviceTypeSelect?.selectedIndex}`
            );
          });
            }
            
            // GPS location functionality for emergency modal
        const useGps = document.getElementById("use-gps");
        const locationInput = document.getElementById("location");
            if (useGps && locationInput) {
          useGps.addEventListener("click", function () {
                    if (navigator.geolocation) {
              useGps.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Getting Location...';
                        useGps.disabled = true;
                        
                        navigator.geolocation.getCurrentPosition(
                function (position) {
                                const lat = position.coords.latitude;
                                const lng = position.coords.longitude;
                                locationInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                  useGps.innerHTML =
                    '<i class="fas fa-map-marker-alt"></i> Use Current Location';
                                useGps.disabled = false;
                            },
                function (error) {
                  alert(
                    "Unable to get your location. Please enter it manually."
                  );
                  useGps.innerHTML =
                    '<i class="fas fa-map-marker-alt"></i> Use Current Location';
                                useGps.disabled = false;
                            }
                        );
                    } else {
              alert("Geolocation is not supported by this browser.");
                    }
                });
            }
            
        // SOS Emergency Functions
        function initializeSOS() {
          getCurrentLocation();
          findNearbyHospitals();
          requestRoadsideAssistance();
        }

        function getCurrentLocation() {
          const locationStatus = document.getElementById("location-status");
          if (navigator.geolocation) {
            locationStatus.innerHTML =
              '<p><i class="fas fa-spinner fa-spin"></i> Getting location...</p>';

            navigator.geolocation.getCurrentPosition(
              function (position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                locationStatus.innerHTML = `<p><i class="fas fa-map-marker-alt"></i> Location: ${lat.toFixed(
                  6
                )}, ${lng.toFixed(6)}</p>`;

                // Store location for sharing
                window.currentLocation = { lat, lng };
              },
              function (error) {
                locationStatus.innerHTML =
                  '<p><i class="fas fa-exclamation-triangle"></i> Location access denied</p>';
              }
            );
          } else {
            locationStatus.innerHTML =
              '<p><i class="fas fa-exclamation-triangle"></i> Geolocation not supported</p>';
          }
        }

        function findNearbyHospitals() {
          const hospitalsDiv = document.getElementById("nearby-hospitals");
          hospitalsDiv.innerHTML =
            '<p><i class="fas fa-spinner fa-spin"></i> Finding nearby hospitals...</p>';

          // Simulate hospital search (in real app, use Google Places API)
          setTimeout(() => {
            hospitalsDiv.innerHTML = `
              <div class="hospital-list">
                <div class="hospital-item">
                  <h4><i class="fas fa-hospital"></i> Apollo Hospital</h4>
                  <p>Distance: 2.3 km | Phone: +91-11-2987-1000</p>
                  <div class="hospital-actions">
                    <button class="hospital-call-btn" onclick="callHospital('+91-11-2987-1000', 'Apollo Hospital')">
                      <i class="fas fa-phone"></i> Call Now
                    </button>
                    <button class="hospital-sos-btn" onclick="sendSOSMessage('Apollo Hospital', '+91-11-2987-1000')">
                      <i class="fas fa-exclamation-triangle"></i> Send SOS
                    </button>
                  </div>
                </div>
                <div class="hospital-item">
                  <h4><i class="fas fa-hospital"></i> Fortis Hospital</h4>
                  <p>Distance: 3.1 km | Phone: +91-11-4277-6222</p>
                  <div class="hospital-actions">
                    <button class="hospital-call-btn" onclick="callHospital('+91-11-4277-6222', 'Fortis Hospital')">
                      <i class="fas fa-phone"></i> Call Now
                    </button>
                    <button class="hospital-sos-btn" onclick="sendSOSMessage('Fortis Hospital', '+91-11-4277-6222')">
                      <i class="fas fa-exclamation-triangle"></i> Send SOS
                    </button>
                  </div>
                </div>
                <div class="hospital-item">
                  <h4><i class="fas fa-hospital"></i> Max Hospital</h4>
                  <p>Distance: 4.2 km | Phone: +91-11-4055-4055</p>
                  <div class="hospital-actions">
                    <button class="hospital-call-btn" onclick="callHospital('+91-11-4055-4055', 'Max Hospital')">
                      <i class="fas fa-phone"></i> Call Now
                    </button>
                    <button class="hospital-sos-btn" onclick="sendSOSMessage('Max Hospital', '+91-11-4055-4055')">
                      <i class="fas fa-exclamation-triangle"></i> Send SOS
                    </button>
                  </div>
                </div>
              </div>
            `;
          }, 2000);
        }

        function requestRoadsideAssistance() {
          const roadsideBtn = document.getElementById("request-roadside");
          if (roadsideBtn) {
            roadsideBtn.addEventListener("click", async function () {
              this.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Requesting Help...';
              this.disabled = true;

              try {
                // Get selected service type
                const serviceTypeSelect =
                  document.getElementById("sos-service-type");
                const selectedServiceType = serviceTypeSelect
                  ? serviceTypeSelect.value
                  : "emergency";

                console.log("ðŸ” SOS Service Type Selection:", {
                  serviceTypeSelect: serviceTypeSelect,
                  selectedServiceType: selectedServiceType,
                  serviceTitle: getServiceTitle(selectedServiceType),
                  allOptions: serviceTypeSelect
                    ? Array.from(serviceTypeSelect.options).map((opt) => ({
                        value: opt.value,
                        text: opt.text,
                        selected: opt.selected,
                      }))
                    : [],
                });

                // Create service request with selected type
                        const payload = {
                  type: selectedServiceType,
                  location: window.currentLocation
                    ? {
                        type: "Point",
                        coordinates: [
                          window.currentLocation.lng,
                          window.currentLocation.lat,
                        ],
                      }
                    : {
                        type: "Point",
                        coordinates: [0, 0], // Will be updated with actual location
                      },
                  address: "Emergency Location",
                  contactName: "Emergency User",
                  contactPhone: "Emergency",
                  description: `SOS ${selectedServiceType} - Immediate roadside assistance required`,
                  priority: "critical",
                };

                console.log("ðŸ” SOS Payload Created:", {
                  type: payload.type,
                  serviceTitle: getServiceTitle(payload.type),
                  description: payload.description,
                });

                const res = await fetch(`${BASE_URL}/api/services`, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(payload),
                });

                if (res.ok) {
                        const service = await res.json();
                  this.innerHTML =
                    '<i class="fas fa-check"></i> Help Requested!';

                  // Store emergency data with correct service type
                        const emergencyData = {
                    service: selectedServiceType,
                    serviceType: selectedServiceType,
                    serviceTitle: getServiceTitle(selectedServiceType),
                    location: `${window.currentLocation?.lat}, ${window.currentLocation?.lng}`,
                    notes: `SOS ${selectedServiceType} - Immediate assistance required`,
                            timestamp: new Date().toISOString(),
                            trackingId: service._id,
                            technician: service.assignedTechnician || null,
                    priority: "critical",
                  };

                  console.log("ðŸ” SOS Emergency Data Stored:", {
                    selectedServiceType: selectedServiceType,
                    serviceTitle: getServiceTitle(selectedServiceType),
                    emergencyData: emergencyData,
                  });

                  localStorage.setItem(
                    "roadRescueEmergency",
                    JSON.stringify(emergencyData)
                  );
                        
                        setTimeout(() => {
                    window.location.href = "track-service.html";
                        }, 2000);
                } else {
                  throw new Error("Failed to request assistance");
                }
              } catch (error) {
                this.innerHTML =
                  '<i class="fas fa-exclamation-triangle"></i> Request Failed';
                console.error("SOS request failed:", error);
              }
            });
          }
        }

        // Emergency number calling function - make it global
        window.callEmergency = function (number) {
          if (confirm(`Call emergency number ${number}?`)) {
            window.location.href = `tel:${number}`;
          }
        };

        // Hospital calling function - make it global
        window.callHospital = function (phoneNumber, hospitalName) {
          console.log("ðŸ” Hospital Call Attempt:", {
            phoneNumber,
            hospitalName,
          });
          if (confirm(`Call ${hospitalName} at ${phoneNumber}?`)) {
            console.log("ðŸ” Initiating call to:", phoneNumber);
            window.location.href = `tel:${phoneNumber}`;
          }
        };

        // Send SOS message to hospital - make it global
        window.sendSOSMessage = function (hospitalName, phoneNumber) {
          console.log("ðŸ” SOS Message Attempt:", { hospitalName, phoneNumber });
          const location = window.currentLocation
            ? `${window.currentLocation.lat}, ${window.currentLocation.lng}`
            : "Location not available";

          const sosMessage = `SOS EMERGENCY ALERT\n\nHospital: ${hospitalName}\nLocation: ${location}\nTime: ${new Date().toLocaleString()}\n\nURGENT: Medical assistance required at the above location. Please dispatch emergency services immediately.`;

          console.log("ðŸ” SOS Message Content:", sosMessage);

          if (
            confirm(
              `Send SOS message to ${hospitalName}?\n\nMessage: ${sosMessage}`
            )
          ) {
            // Try to send SMS
            if (navigator.share) {
              navigator
                .share({
                  title: "SOS Emergency Alert",
                  text: sosMessage,
                  url: `sms:${phoneNumber}?body=${encodeURIComponent(
                    sosMessage
                  )}`,
                })
                .catch((err) => {
                  console.error("Error sharing:", err);
                  // Fallback to direct SMS link
                  window.location.href = `sms:${phoneNumber}?body=${encodeURIComponent(
                    sosMessage
                  )}`;
                });
            } else {
              // Fallback to direct SMS link
              window.location.href = `sms:${phoneNumber}?body=${encodeURIComponent(
                sosMessage
              )}`;
            }
          }
        };

        // Share location function
        const shareLocationBtn = document.getElementById("share-location");
        if (shareLocationBtn) {
          shareLocationBtn.addEventListener("click", function () {
            if (navigator.share && window.currentLocation) {
              navigator.share({
                title: "Emergency Location",
                text: `Emergency at location: ${window.currentLocation.lat}, ${window.currentLocation.lng}`,
                url: `https://maps.google.com/?q=${window.currentLocation.lat},${window.currentLocation.lng}`,
              });
            } else if (window.currentLocation) {
              // Fallback: copy to clipboard
              const locationText = `Emergency Location: ${window.currentLocation.lat}, ${window.currentLocation.lng}`;
              navigator.clipboard.writeText(locationText).then(() => {
                alert("Location copied to clipboard!");
              });
            } else {
              alert("Location not available. Please enable location access.");
                    }
                });
            }
            
            // Dark mode toggle
        const themeToggle = document.getElementById("theme-toggle");
            if (themeToggle) {
          themeToggle.addEventListener("click", function () {
            document.body.classList.toggle("dark-mode");
                });
            }
            
            // GPS location functionality for payment modal
        const paymentUseGps = document.getElementById("payment-use-gps");
        const paymentLocation = document.getElementById("payment-location");
            if (paymentUseGps && paymentLocation) {
          paymentUseGps.addEventListener("click", function () {
                    if (navigator.geolocation) {
              paymentUseGps.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Getting Location...';
                        paymentUseGps.disabled = true;
                        
                        navigator.geolocation.getCurrentPosition(
                function (position) {
                                const lat = position.coords.latitude;
                                const lng = position.coords.longitude;
                  paymentLocation.value = `${lat.toFixed(6)}, ${lng.toFixed(
                    6
                  )}`;
                  paymentUseGps.innerHTML =
                    '<i class="fas fa-map-marker-alt"></i> Use Current Location';
                                paymentUseGps.disabled = false;
                            },
                function (error) {
                  alert(
                    "Unable to get your location. Please enter it manually."
                  );
                  paymentUseGps.innerHTML =
                    '<i class="fas fa-map-marker-alt"></i> Use Current Location';
                                paymentUseGps.disabled = false;
                            }
                        );
                    } else {
              alert("Geolocation is not supported by this browser.");
                    }
                });
            }
            
            // Payment form handling (POST to backend)
        const paymentForm = document.getElementById("payment-form");
            if (paymentForm) {
          paymentForm.addEventListener("submit", async function (e) {
                    e.preventDefault();
                    
            const submitBtn = paymentForm.querySelector(".submit-button");
                    if (submitBtn) {
                        submitBtn.disabled = true;
              submitBtn.innerHTML =
                '<i class="fas fa-spinner fa-spin"></i> Booking...';
                    }
                    
                    try {
                        const formData = new FormData(paymentForm);
              const rawLocation = formData.get("payment-location") || "";
                        let locationGeo = null;
              if (rawLocation && rawLocation.includes(",")) {
                const parts = rawLocation.split(",");
                            const lat = parseFloat(parts[0]);
                            const lng = parseFloat(parts[1]);
                            if (!isNaN(lat) && !isNaN(lng)) {
                  locationGeo = { type: "Point", coordinates: [lng, lat] };
                }
              }

              const vehicleRaw = (
                formData.get("payment-vehicle-info") || ""
              ).trim();
              const vehicleParts = vehicleRaw
                .split(/[-,]/)
                .map((s) => s.trim());
                        const vehicleDetails = {
                year:
                  vehicleParts[0] && /\d{4}/.test(vehicleParts[0])
                    ? vehicleParts[0]
                    : "",
                make: vehicleParts[1] || vehicleParts[0] || "",
                model: vehicleParts[2] || "",
                color: vehicleParts[3] || "",
                fuelType: formData.get("payment-fuel-type") || "",
                        };
                        
                        const payload = {
                type: currentService || "battery",
                location: locationGeo || {
                  type: "Point",
                  coordinates: [77.3635, 28.6275],
                },
                address: rawLocation || "Unknown",
                contactName: formData.get("payment-name") || "",
                contactPhone: formData.get("payment-phone") || "",
                            vehicleDetails,
                description:
                  formData.get("payment-notes") ||
                  getServiceTitle(currentService),
              };

              const res = await fetch(`${BASE_URL}/api/services`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
                        });
                        
                        if (!res.ok) {
                throw new Error("Failed to create service");
                        }
                        const service = await res.json();
                        
                        // Persist minimal booking info for the tracking page
                        const bookingData = {
                service: service.type, // Use the actual service type from backend
                serviceType: service.type, // Use the actual service type from backend
                serviceTitle: getServiceTitle(service.type), // Use the actual service type from backend
                            location: rawLocation,
                notes: formData.get("payment-notes") || "",
                            timestamp: new Date().toISOString(),
                            trackingId: service._id,
                technician: service.assignedTechnician || null,
              };
              try {
                localStorage.setItem(
                  "roadRescueBooking",
                  JSON.stringify(bookingData)
                );
              } catch (_) {}

              const successMessage = document.getElementById("success-message");
              const successText = document.getElementById(
                "success-message-text"
              );
                        if (successMessage && successText) {
                successText.textContent = `Your ${getServiceTitle(
                  currentService
                )} has been booked! Tracking # ${service._id}`;
                successMessage.style.display = "flex";
              }
              paymentModal.style.display = "none";
                        
                        setTimeout(() => {
                window.location.href = "track-service.html";
                        }, 1500);
                    } catch (err) {
              alert("Booking failed. Please try again.");
                        console.error(err);
                    } finally {
                        if (submitBtn) {
                            submitBtn.disabled = false;
                submitBtn.innerHTML =
                  '<i class="fas fa-check-circle"></i> Confirm Booking';
                        }
                    }
                });
            }
            
            // Mobile menu toggle
        const mobileMenu = document.getElementById("mobile-menu");
        const navLinks = document.querySelector(".nav-links");
            if (mobileMenu && navLinks) {
          mobileMenu.addEventListener("click", function () {
            navLinks.classList.toggle("active");
                });
            }
            
            // Service animation on scroll
            enhanceServicesSection();
        });
    </script>
</body>
</html> 
