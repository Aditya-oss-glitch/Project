<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mechanic Dashboard | RoadRescue360</title>
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      .btn-done:hover {
        background-color: #218838 !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
      }
      
      .btn-done:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="container">
        <div class="logo">
          <h1>
            <i class="fas fa-wrench"></i>
            <span class="logo-text"
              >Mechanic<span class="logo-highlight">Desk</span></span
            >
          </h1>
        </div>
        <div class="nav-links">
          <a href="mechanic-home.html" class="active">Home</a>
          <a href="#assignments">Assignments</a>
          <a href="#profile">Profile</a>
          <a href="#" id="logout">Logout</a>
        </div>
      </div>
    </nav>

    <main class="main-content">
      <div class="container">
        <section class="page-header" style="margin-bottom: 30px">
          <h1>Mechanic Desk</h1>
          <p>
            Track customer requests, view assigned jobs, and keep your profile
            up to date. Everything you need to deliver fast roadside assistance.
          </p>
          <div class="services-grid" style="margin-top: 25px">
            <div
              class="service-item"
              style="min-height: auto; text-align: center"
            >
              <h3 style="margin-bottom: 8px">Active Jobs</h3>
              <div class="stat-number" id="stat-active" style="color: #0056b3; font-weight: bold; font-size: 2rem;">0</div>
            </div>
            <div
              class="service-item"
              style="min-height: auto; text-align: center"
            >
              <h3 style="margin-bottom: 8px">Pending</h3>
              <div class="stat-number" id="stat-pending" style="color: #0056b3; font-weight: bold; font-size: 2rem;">0</div>
            </div>
            <div
              class="service-item"
              style="min-height: auto; text-align: center"
            >
              <h3 style="margin-bottom: 8px">Completed</h3>
              <div class="stat-number" id="stat-completed" style="color: #0056b3; font-weight: bold; font-size: 2rem;">0</div>
            </div>
          </div>
        </section>
        <section class="services-section">
          <h2 class="section-title">
            <i class="fas fa-clipboard-list section-title-icon"></i> Active
            Assignments
          </h2>
          <div id="assignments" class="services-grid"></div>
          <small
            style="
              display: block;
              text-align: center;
              color: var(--secondary);
              margin-top: 10px;
            "
            >Assignments reflect live bookings from users and status
            updates.</small
          >
        </section>
        <section class="services-section">
          <h2 class="section-title">
            <i class="fas fa-users section-title-icon"></i> Customers
          </h2>
          <div class="service-item" style="padding: 20px">
            <form id="c-form" style="display: flex; gap: 10px; flex-wrap: wrap">
              <input id="c-name" placeholder="Name" required />
              <input id="c-phone" placeholder="Phone" required />
              <input id="c-note" placeholder="Note" />
              <button class="btn btn-primary" type="submit">
                Add Customer
              </button>
            </form>
            <div
              id="c-list"
              class="details-grid"
              style="margin-top: 15px"
            ></div>
          </div>
        </section>
        <section class="services-section">
          <h2 class="section-title">
            <i class="fas fa-tools section-title-icon"></i> Services
          </h2>
          <div class="service-item" style="padding: 20px">
            <form id="s-form" style="display: flex; gap: 10px; flex-wrap: wrap">
              <input id="s-name" placeholder="Service name" required />
              <input
                id="s-price"
                type="number"
                min="0"
                placeholder="Price"
                required
              />
              <button class="btn btn-primary" type="submit">Add Service</button>
            </form>
            <div
              id="s-list"
              class="details-grid"
              style="margin-top: 15px"
            ></div>
          </div>
        </section>
        <section class="services-section">
          <h2 class="section-title">
            <i class="fas fa-briefcase section-title-icon"></i> Jobs
          </h2>
          <div class="service-item" style="padding: 20px">
            <form id="j-form" style="display: flex; gap: 10px; flex-wrap: wrap">
              <select id="j-customer" required></select>
              <select id="j-service" required></select>
              <input id="j-notes" placeholder="Notes" />
              <button class="btn btn-primary" type="submit">Create Job</button>
            </form>
            <div
              id="j-list"
              class="details-grid"
              style="margin-top: 15px"
            ></div>
          </div>
        </section>
        <section id="profile" class="services-section">
          <h2 class="section-title">
            <i class="fas fa-id-badge section-title-icon"></i> My Profile
          </h2>
          <div class="service-item" style="padding: 20px">
            <div style="display: flex; gap: 20px; align-items: flex-start">
              <div>
                <img
                  id="avatar"
                  src="https://via.placeholder.com/120x120?text=Avatar"
                  alt="Avatar"
                  style="
                    width: 120px;
                    height: 120px;
                    border-radius: 50%;
                    object-fit: cover;
                    border: 3px solid var(--primary-light);
                  "
                />
                <form id="avatar-form" style="margin-top: 10px">
                  <input type="file" id="avatar-file" accept="image/*" />
                  <button
                    class="btn btn-primary"
                    type="submit"
                    style="margin-top: 6px"
                  >
                    Upload
                  </button>
                </form>
              </div>
              <div style="flex: 1">
                <div id="me-profile">Loading...</div>
                <button id="edit-profile-btn" class="btn btn-primary" style="margin-top: 15px;">
                  <i class="fas fa-edit"></i> Edit Profile
                </button>
                <form id="profile-form" style="margin-top: 15px; display: none;">
                  <div class="details-grid">
                    <div class="detail-card">
                      <div class="detail-content">
                        <div class="detail-label">Name</div>
                        <input id="p-name" />
                      </div>
                    </div>
                    <div class="detail-card">
                      <div class="detail-content">
                        <div class="detail-label">Phone</div>
                        <input id="p-phone" />
                      </div>
                    </div>
                    <div class="detail-card">
                      <div class="detail-content">
                        <div class="detail-label">Vehicle</div>
                        <input id="p-vehicle" />
                      </div>
                    </div>
                    <div class="detail-card">
                      <div class="detail-content">
                        <div class="detail-label">License Plate</div>
                        <input id="p-plate" />
                      </div>
                    </div>
                    <div class="detail-card full-width">
                      <div class="detail-content">
                        <div class="detail-label">
                          Specialties (comma-separated)
                        </div>
                        <input
                          id="p-specialties"
                          type="text"
                          placeholder="e.g., battery, fuel, mechanical, ev_charging"
                          style="
                            width: 100%;
                            padding: 8px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                          "
                        />
                        <small
                          style="
                            color: #666;
                            font-size: 12px;
                            margin-top: 4px;
                            display: block;
                          "
                        >
                          Available specialties: battery, fuel, mechanical,
                          towing, tire, lockout, mobile_repair,
                          accident_recovery, ev_charging, ev_towing,
                          ev_battery_swap, ev_diagnostics
                        </small>
                      </div>
                    </div>
                  </div>
                  <button
                    class="btn btn-primary"
                    type="submit"
                    style="margin-top: 10px"
                  >
                    Save Changes
                  </button>
                </form>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
    <script src="config.js"></script>
    <script>
      function getToken() {
        try {
          return JSON.parse(localStorage.getItem("rr_tech_token"));
        } catch (_) {
          return null;
        }
      }
      function authHeader() {
        const t = getToken();
        console.log('üîç Token from localStorage:', t);
        const header = t ? { Authorization: "Bearer " + t } : {};
        console.log('üîç Auth header:', header);
        return header;
      }
      function ensureAuth() {
        if (!getToken()) {
          window.location.href = "login.html";
        }
      }
      ensureAuth();

      document.getElementById("logout").addEventListener("click", (e) => {
        e.preventDefault();
        localStorage.removeItem("rr_tech_token");
        window.location.href = "login.html";
      });

      async function loadAssignments() {
        const container = document.getElementById("assignments");
        container.innerHTML = "";
        try {
          const res = await fetch(`${BASE_URL}/api/services/assigned/me`, {
            headers: { ...authHeader() },
          });
          const services = await res.json();
          const my = services.slice(0, 8);
          // stats
          const active = services.filter(
            (s) => s.status === "assigned" || s.status === "in_progress"
          ).length;
          const pending = services.filter((s) => s.status === "pending").length;
          const completed = services.filter(
            (s) => s.status === "completed"
          ).length;
          document.getElementById("stat-active").textContent = active;
          document.getElementById("stat-pending").textContent = pending;
          document.getElementById("stat-completed").textContent = completed;
          if (!my.length) {
            container.innerHTML =
              '<div class="service-item">No assignments yet. New user bookings will appear here automatically.</div>';
          } else {
            my.forEach((s) => {
              const el = document.createElement("div");
              el.className = "service-item";
              const contact = `${s.contactName || "Customer"} ‚Ä¢ ${
                s.contactPhone || ""
              }`;
              const addr = s.address || "";
              const v = s.vehicleDetails
                ? `${s.vehicleDetails.year || ""} ${
                    s.vehicleDetails.make || ""
                  } ${s.vehicleDetails.model || ""}`.trim()
                : "";
              const assigned = s.assignedTechnician ? "Assigned" : "Unassigned";
              const coords =
                s.location &&
                s.location.coordinates &&
                s.location.coordinates.length === 2
                  ? {
                      lng: s.location.coordinates[0],
                      lat: s.location.coordinates[1],
                    }
                  : null;
              const mapImg = coords
                ? `https://maps.googleapis.com/maps/api/staticmap?center=${coords.lat},${coords.lng}&zoom=14&size=400x180&markers=color:red%7C${coords.lat},${coords.lng}`
                : "";
              const timeline = `
                            <div class="timeline" style="margin-top:10px;">
                                <div class="timeline-item ${
                                  s.status !== "pending" ? "completed" : ""
                                }"><div class="timeline-marker"><i class="fas fa-check"></i></div><div class="timeline-content"><div class="timeline-title">Request Received</div></div></div>
                                <div class="timeline-item ${
                                  s.status === "assigned" ||
                                  s.status === "in_progress" ||
                                  s.status === "completed"
                                    ? "active"
                                    : ""
                                }"><div class="timeline-marker"><i class="fas fa-user-cog"></i></div><div class="timeline-content"><div class="timeline-title">Technician Assigned</div></div></div>
                                <div class="timeline-item ${
                                  s.status === "in_progress" ||
                                  s.status === "completed"
                                    ? "active"
                                    : ""
                                }"><div class="timeline-marker"><i class="fas fa-route"></i></div><div class="timeline-content"><div class="timeline-title">En Route</div></div></div>
                                <div class="timeline-item ${
                                  s.status === "completed" ? "completed" : ""
                                }"><div class="timeline-marker"><i class="fas fa-flag-checkered"></i></div><div class="timeline-content"><div class="timeline-title">Completed</div></div></div>
                            </div>`;
              // Check if this is an emergency/SOS request
              const isEmergency =
                s.type === "emergency" || s.priority === "critical";
              const priorityIcon = isEmergency
                ? '<i class="fas fa-exclamation-triangle"></i>'
                : '<i class="fas fa-clipboard-check"></i>';
              const priorityClass = isEmergency ? "emergency-request" : "";
              const priorityBadge = isEmergency
                ? '<div class="emergency-badge"><i class="fas fa-exclamation-triangle"></i> SOS EMERGENCY</div>'
                : "";

              el.innerHTML = `
                            <div class="service-icon ${priorityClass}">${priorityIcon}</div>
                            ${priorityBadge}
                            <div class="service-category"><span><i class="fas fa-tag"></i> ${
                              s.type
                            }</span></div>
                            <h3>${contact}</h3>
                            <p><i class="fas fa-map-marker-alt"></i> ${addr}</p>
                            <p><i class="fas fa-car"></i> ${v || "N/A"}</p>
                            ${
                              mapImg
                                ? `<img src="${mapImg}" alt="map" style="width:100%;border-radius:10px;margin:6px 0;">`
                                : ""
                            }
                            ${timeline}
                            <div class="service-buttons">
                                <a class="btn-learn" href="track-service.html">Track</a>
                                <button class="btn-done" onclick="markJobComplete('${s._id}')" style="background-color: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-left: 10px; transition: all 0.3s ease; font-weight: 500;">
                                    <i class="fas fa-check"></i> Done
                                </button>
                                <span class="btn-book" style="text-align:center;">${assigned}</span>
                            </div>`;
              container.appendChild(el);
            });
          }
        } catch (e) {
          container.innerHTML =
            '<div class="service-item">Failed to load assignments.</div>';
        }
      }

      async function loadProfile() {
        const box = document.getElementById("me-profile");
        box.textContent = "Loading...";
        try {
          console.log('üîç Loading technician profile...');
          console.log('üîç BASE_URL:', BASE_URL);
          console.log('üîç Auth header:', authHeader());
          
          const res = await fetch(`${BASE_URL}/api/auth/technician/me`, {
            headers: { ...authHeader() },
          });
          
          console.log('üîç Response status:', res.status);
          console.log('üîç Response headers:', res.headers);
          
          const tech = await res.json();
          console.log('üîç Response data:', tech);
          
          if (!res.ok) throw new Error(tech.error || "Failed to load");
          document.getElementById("avatar").src =
            tech.avatarUrl || document.getElementById("avatar").src;
          box.innerHTML = `
                    <p><strong>Name:</strong> ${tech.name}</p>
                    <p><strong>Email:</strong> ${tech.email}</p>
                    <p><strong>Phone:</strong> ${tech.phone || ""}</p>
                    <p><strong>Vehicle:</strong> ${tech.vehicle || ""}</p>
                    <p><strong>License Plate:</strong> ${
                      tech.licensePlate || ""
                    }</p>
                    <p><strong>Specialties:</strong> ${(
                      tech.specialties || []
                    ).join(", ")}</p>
                `;
          document.getElementById("p-name").value = tech.name || "";
          document.getElementById("p-phone").value = tech.phone || "";
          document.getElementById("p-vehicle").value = tech.vehicle || "";
          document.getElementById("p-plate").value = tech.licensePlate || "";
          const specialtiesInput = document.getElementById("p-specialties");
          if (specialtiesInput) {
            specialtiesInput.value = (tech.specialties || []).join(", ");
            console.log(
              "üîç Specialties input populated:",
              specialtiesInput.value
            );
            console.log(
              "üîç Specialties input disabled:",
              specialtiesInput.disabled
            );
            console.log(
              "üîç Specialties input readonly:",
              specialtiesInput.readOnly
            );
          } else {
            console.error("‚ùå Specialties input element not found!");
          }
        } catch (e) {
          box.textContent = "Failed to load profile.";
        }
      }

      loadAssignments();
      loadProfile();

      // Debug: Add event listeners to specialties input
      const specialtiesInput = document.getElementById("p-specialties");
      if (specialtiesInput) {
        specialtiesInput.addEventListener("click", () => {
          console.log("üîç Specialties input clicked");
        });
        specialtiesInput.addEventListener("focus", () => {
          console.log("üîç Specialties input focused");
        });
        specialtiesInput.addEventListener("input", () => {
          console.log("üîç Specialties input changed:", specialtiesInput.value);
        });
      } else {
        console.error("‚ùå Specialties input not found during initialization");
      }

      // Real-time SOS notifications
      let lastAssignmentCount = 0;
      setInterval(async () => {
        try {
          const res = await fetch(`${BASE_URL}/api/services/assigned/me`, {
            headers: { ...authHeader() },
          });
          const services = await res.json();
          const currentCount = services.length;

          // Check for new emergency requests
          const emergencyServices = services.filter(
            (s) => s.type === "emergency" || s.priority === "critical"
          );
          if (
            emergencyServices.length > 0 &&
            currentCount > lastAssignmentCount
          ) {
            showSOSNotification(emergencyServices[0]);
          }

          lastAssignmentCount = currentCount;
        } catch (e) {
          console.error("Error checking for new assignments:", e);
        }
      }, 5000); // Check every 5 seconds

      function showSOSNotification(service) {
        // Create notification element
        const notification = document.createElement("div");
        notification.className = "sos-notification";
        notification.innerHTML = `
                <div class="sos-notification-content">
                    <div class="sos-notification-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="sos-notification-text">
                        <h4>SOS EMERGENCY REQUEST</h4>
                        <p>New emergency service request from ${
                          service.contactName || "Customer"
                        }</p>
                        <p><i class="fas fa-map-marker-alt"></i> ${
                          service.address
                        }</p>
                    </div>
                    <button class="sos-notification-close" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

        // Add to page
        document.body.appendChild(notification);

        // Auto-remove after 10 seconds
        setTimeout(() => {
          if (notification.parentElement) {
            notification.remove();
          }
        }, 10000);

        // Play notification sound (if supported)
        try {
          const audio = new Audio(
            "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT"
          );
          audio.play().catch(() => {}); // Ignore errors if audio fails
        } catch (e) {}
      }

      // Save profile
      document
        .getElementById("profile-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const specialtiesInput = document.getElementById("p-specialties");
          const specialtiesValue = specialtiesInput
            ? specialtiesInput.value
            : "";
          console.log(
            "üîç Form submission - specialties raw value:",
            specialtiesValue
          );

          const payload = {
            name: document.getElementById("p-name").value.trim(),
            phone: document.getElementById("p-phone").value.trim(),
            vehicle: document.getElementById("p-vehicle").value.trim(),
            licensePlate: document.getElementById("p-plate").value.trim(),
            specialties: specialtiesValue
              .split(",")
              .map((s) => s.trim())
              .filter(Boolean),
          };

          console.log("üîç Form submission - payload:", payload);
          console.log("üîç BASE_URL:", BASE_URL);
          console.log("üîç Auth header:", authHeader());
          
          const res = await fetch(`${BASE_URL}/api/auth/technician/me`, {
            method: "PUT",
            headers: { "Content-Type": "application/json", ...authHeader() },
            body: JSON.stringify(payload),
          });
          
          console.log("üîç Save response status:", res.status);
          const data = await res.json();
          console.log("üîç Save response data:", data);
          
          if (!res.ok) return alert(data.error || "Update failed");
          alert("Profile updated");
          loadProfile();
          
          // Hide the form after successful update
          const profileForm = document.getElementById("profile-form");
          const editBtn = document.getElementById("edit-profile-btn");
          profileForm.style.display = "none";
          editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Profile';
          editBtn.classList.remove("btn-secondary");
          editBtn.classList.add("btn-primary");
        });

      // Upload avatar
      document
        .getElementById("avatar-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const file = document.getElementById("avatar-file").files[0];
          if (!file) return alert("Choose an image");
          const fd = new FormData();
          fd.append("avatar", file);
          const res = await fetch(`${BASE_URL}/api/auth/technician/avatar`, {
            method: "POST",
            headers: { ...authHeader() },
            body: fd,
          });
          const data = await res.json();
          if (!res.ok) return alert(data.error || "Upload failed");
          document.getElementById("avatar").src = data.avatarUrl;
        });

      // MD helpers
      async function mdGet(path) {
        const r = await fetch(`${BASE_URL}/api/md` + path, {
          headers: { ...authHeader(), "Content-Type": "application/json" },
        });
        return r.json();
      }
      async function mdPost(path, body) {
        const r = await fetch(`${BASE_URL}/api/md` + path, {
          method: "POST",
          headers: { ...authHeader(), "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        return r.json();
      }
      async function mdPut(path, body) {
        const r = await fetch(`${BASE_URL}/api/md` + path, {
          method: "PUT",
          headers: { ...authHeader(), "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        return r.json();
      }

      // Customers UI
      async function refreshCustomers() {
        const list = await mdGet("/customers");
        const box = document.getElementById("c-list");
        box.innerHTML = "";
        list.forEach((c) => {
          const el = document.createElement("div");
          el.className = "detail-card";
          el.innerHTML = `<div class="detail-content"><div class="detail-label">${
            c.name
          }</div><div class="detail-value">${c.phone}${
            c.note ? " ‚Ä¢ " + c.note : ""
          }</div></div>`;
          box.appendChild(el);
        });
        // populate dropdown
        const sel = document.getElementById("j-customer");
        sel.innerHTML =
          '<option value="" disabled selected>Select customer</option>' +
          list
            .map(
              (c) => `<option value="${c._id}">${c.name} (${c.phone})</option>`
            )
            .join("");
      }
      document
        .getElementById("c-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          await mdPost("/customers", {
            name: document.getElementById("c-name").value.trim(),
            phone: document.getElementById("c-phone").value.trim(),
            note: document.getElementById("c-note").value.trim(),
          });
          document.getElementById("c-form").reset();
          refreshCustomers();
        });

      // Services UI
      async function refreshServices() {
        const list = await mdGet("/services");
        const box = document.getElementById("s-list");
        box.innerHTML = "";
        list.forEach((s) => {
          const el = document.createElement("div");
          el.className = "detail-card";
          el.innerHTML = `<div class="detail-content"><div class="detail-label">${s.name}</div><div class="detail-value">‚Çπ${s.price}</div></div>`;
          box.appendChild(el);
        });
        const sel = document.getElementById("j-service");
        sel.innerHTML =
          '<option value="" disabled selected>Select service</option>' +
          list
            .map(
              (s) => `<option value="${s._id}">${s.name} (‚Çπ${s.price})</option>`
            )
            .join("");
      }
      document
        .getElementById("s-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          await mdPost("/services", {
            name: document.getElementById("s-name").value.trim(),
            price: Number(document.getElementById("s-price").value),
          });
          document.getElementById("s-form").reset();
          refreshServices();
        });

      // Jobs UI
      async function refreshJobs() {
        const list = await mdGet("/jobs");
        const box = document.getElementById("j-list");
        box.innerHTML = "";
        list.forEach((j) => {
          const el = document.createElement("div");
          el.className = "detail-card full-width";
          el.innerHTML = `<div class="detail-content"><div class="detail-label">${
            j.customer?.name || ""
          } ‚Üí ${
            j.service?.name || ""
          }</div><div class="detail-value">Status: <strong>${
            j.status
          }</strong></div></div><div><select data-id="${j._id}"><option ${
            j.status === "pending" ? "selected" : ""
          }>pending</option><option ${
            j.status === "in_progress" ? "selected" : ""
          }>in_progress</option><option ${
            j.status === "completed" ? "selected" : ""
          }>completed</option></select></div>`;
          box.appendChild(el);
          const sel = el.querySelector("select");
          sel.addEventListener("change", async () => {
            await mdPut("/jobs/" + j._id, { status: sel.value });
            refreshJobs();
          });
        });
      }
      document
        .getElementById("j-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          await mdPost("/jobs", {
            customerId: document.getElementById("j-customer").value,
            serviceId: document.getElementById("j-service").value,
            notes: document.getElementById("j-notes").value.trim(),
          });
          document.getElementById("j-form").reset();
          refreshJobs();
        });

      // Edit profile button functionality
      document.getElementById("edit-profile-btn").addEventListener("click", function() {
        const profileForm = document.getElementById("profile-form");
        const editBtn = document.getElementById("edit-profile-btn");
        
        if (profileForm.style.display === "none" || profileForm.style.display === "") {
          // Show the form
          profileForm.style.display = "block";
          editBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
          editBtn.classList.remove("btn-primary");
          editBtn.classList.add("btn-secondary");
          
          // Focus on first input field
          setTimeout(() => {
            const firstInput = document.querySelector("#profile-form input");
            if (firstInput) {
              firstInput.focus();
            }
          }, 100);
        } else {
          // Hide the form
          profileForm.style.display = "none";
          editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit Profile';
          editBtn.classList.remove("btn-secondary");
          editBtn.classList.add("btn-primary");
        }
      });

      // Mark job as complete function
      async function markJobComplete(jobId) {
        // Show confirmation dialog
        if (!confirm("Are you sure you want to mark this job as completed?")) {
          return;
        }
        
        try {
          // First, get the job details before marking as complete
          const jobRes = await fetch(`${BASE_URL}/api/services/${jobId}`, {
            headers: { ...authHeader() }
          });
          
          let jobDetails = null;
          if (jobRes.ok) {
            jobDetails = await jobRes.json();
          }
          
          const res = await fetch(`${BASE_URL}/api/services/${jobId}/status`, {
            method: "PUT",
            headers: { ...authHeader(), "Content-Type": "application/json" },
            body: JSON.stringify({ status: "completed" })
          });
          
          if (!res.ok) {
            const error = await res.json();
            throw new Error(error.error || "Failed to mark job as complete");
          }
          
          // Save completed service to localStorage for user's service history
          if (jobDetails) {
            const completedService = {
              id: jobDetails._id || jobId,
              serviceType: jobDetails.serviceType || jobDetails.service,
              service: jobDetails.service,
              location: jobDetails.location,
              vehicleDetails: jobDetails.vehicleDetails,
              name: jobDetails.name,
              phone: jobDetails.phone,
              email: jobDetails.email,
              notes: jobDetails.notes,
              status: 'Completed',
              technician: 'Current Technician', // You can get this from the technician profile
              date: new Date().toISOString(),
              completedAt: new Date().toISOString(),
              trackingId: jobDetails.trackingId
            };
            
            // Get existing completed services
            const completedServices = JSON.parse(localStorage.getItem('completed_services') || '[]');
            completedServices.push(completedService);
            
            // Save back to localStorage
            localStorage.setItem('completed_services', JSON.stringify(completedServices));
            
            // Also update the all bookings list
            const allBookings = JSON.parse(localStorage.getItem('all_service_bookings') || '[]');
            const bookingIndex = allBookings.findIndex(b => b.trackingId === completedService.trackingId);
            if (bookingIndex !== -1) {
                allBookings[bookingIndex] = completedService;
            } else {
                allBookings.push(completedService);
            }
            localStorage.setItem('all_service_bookings', JSON.stringify(allBookings));
            
            console.log('Service marked as completed and saved to history:', completedService);
          }
          
          // Show success message
          alert("Job marked as completed successfully!");
          
          // Reload assignments to update the counts and remove completed job
          loadAssignments();
          
        } catch (error) {
          console.error("Error marking job as complete:", error);
          alert("Failed to mark job as complete: " + error.message);
        }
      }
      
      // Make function globally available
      window.markJobComplete = markJobComplete;

      // Initial loads
      refreshCustomers();
      refreshServices();
      refreshJobs();
    </script>
  </body>
</html>
